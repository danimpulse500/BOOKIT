<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Book-It | Post Lodge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>

  <link rel="stylesheet" href="css/style.css">
  <style>
    /* BODY & LAYOUT */
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      background: #f7f7f7;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header.navbar,
    footer.footer {
      flex-shrink: 0;
      padding: 15px 30px;
      background: #fff;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .form-wrapper {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      overflow: hidden;
    }

    /* MULTI-STEP FORM */
    .multi-step-form {
      background: #fff;
      border-radius: 12px;
      width: 100%;
      max-width: 550px;
      max-height: 85vh;
      padding: 30px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .form-step {
      display: none;
      flex-direction: column;
      overflow-y: auto;
      max-height: calc(85vh - 80px);
      padding-right: 10px;
    }

    .form-step.active {
      display: flex;
    }

    .form-step h2 {
      text-align: center;
      margin-bottom: 20px;
      font-weight: 600;
    }

    label {
      margin-top: 15px;
      font-weight: 500;
      font-size: 14px;
      color: #333;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 12px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 15px;
      outline: none;
      box-sizing: border-box;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 25px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    .buttons button {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
    }

    .prev-btn {
      background: #ddd;
      color: #333;
    }

    .prev-btn:hover {
      background: #ccc;
    }

    .next-btn {
      background: linear-gradient(135deg, #130569, #2b1bbf);
      color: #fff;
    }

    .next-btn:hover {
      background: linear-gradient(135deg, #130569, #2b1bbf);
      opacity: 0.9;
    }

    /* PROGRESS BAR */
    .progress-container {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(135deg, #130569, #2b1bbf);
      transition: width 0.3s ease-in-out;
    }

    /* IMAGE PREVIEW */
    .image-preview-container {
      margin-top: 10px;
      max-height: 200px;
      overflow-y: auto;
    }

    /* LOADING AND MESSAGE STYLES */
    .loading {
      display: none;
      text-align: center;
      color: #0a7cff;
      margin: 10px 0;
    }

    .error-message {
      display: none;
      background: #ffebee;
      color: #c62828;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 14px;
      white-space: pre-wrap;
    }

    .success-message {
      display: none;
      background: #e8f5e9;
      color: #2e7d32;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 14px;
    }

    /* MODAL STYLES */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background-color: #fff;
      margin: 15% auto;
      padding: 20px;
      border-radius: 12px;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: #333;
    }

    /* Multiple image upload */
    .image-upload-container {
      margin-top: 10px;
    }

    .image-preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .image-preview-item {
      width: 100%;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #ddd;
    }

    .remove-image {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #dc3545;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      text-align: center;
      line-height: 22px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .image-item {
      position: relative;
    }

    /* Authentication warning */
    .auth-warning {
      background: #fff3cd;
      color: #856404;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
      font-size: 14px;
      border: 1px solid #ffeaa7;
    }

    .auth-warning a {
      color: #0a7cff;
      text-decoration: none;
      font-weight: 600;
    }

    .auth-warning a:hover {
      text-decoration: underline;
    }

    /* Amenities checkbox grid */
    .amenities-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 10px;
    }

    .amenity-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px;
    }

    .amenity-option input[type="checkbox"] {
      width: auto;
      margin: 0;
      transform: scale(1.2);
    }

    .amenity-option label {
      margin: 0;
      font-weight: normal;
      font-size: 14px;
      color: #333;
    }

    /* Form row for inline fields */
    .form-row {
      display: flex;
      gap: 15px;
      margin-top: 15px;
    }

    .form-col {
      flex: 1;
    }

    /* Checkbox for is_available */
    .availability-checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 15px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .availability-checkbox input[type="checkbox"] {
      width: auto;
      margin: 0;
      transform: scale(1.2);
    }

    /* Optional label style */
    .optional {
      color: #666;
      font-weight: normal;
    }

    /* Scrollbar styling */
    .form-step::-webkit-scrollbar {
      width: 6px;
    }

    .form-step::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }

    .form-step::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }

    .form-step::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    /* Small info text */
    .info-text {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
      margin-bottom: 10px;
    }
  </style>
</head>

<body>

  <header class="navbar">
    <a href="index.html" class="logo">
      <img src="logo.png" alt="Book-It Logo">
    </a>

    <!-- Desktop Menu -->
    <nav class="menu-panel desktop-nav" id="navMenu">
      <a href="index.html">Home</a>
      <a href="contact.html">Contact/Support</a>
      <a href="post.html" id="postLink">Post Lodge</a>
      <div class="user-area" id="userArea"></div>
    </nav>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">☰</button>

    <!-- Mobile Menu -->
    <nav class="menu-panel mobile-nav" id="mobileNav"></nav>
  </header>

  <div class="form-wrapper">
    <form id="multiStepForm" class="multi-step-form" enctype="multipart/form-data">

      <div class="progress-container">
        <div id="progressBar" class="progress-bar"></div>
      </div>

      <!-- Authentication Warning -->
      <div id="authWarning" class="auth-warning" style="display: none;">
        <strong>⚠️ Agent Account Required</strong><br>
        You need to be logged in as an agent to post listings.
        <a href="signup.html">Sign up as an agent</a> or <a href="login.html">login</a>.
      </div>

      <!-- Error and Success Messages -->
      <div class="error-message" id="error-message"></div>
      <div class="success-message" id="success-message"></div>
      <div class="loading" id="loading">Uploading listing...</div>

      <!-- Step 1: Basic Info -->
      <div class="form-step active">
        <h2>Basic Information</h2>

        <label for="lodge_name">Lodge Name *</label>
        <input type="text" id="lodge_name" placeholder="Enter lodge/property name" required>

        <label for="total_rooms">Total Rooms *</label>
        <input type="number" id="total_rooms" min="1" value="1" required>

        <label for="room_type">Room Type *</label>
        <select id="room_type" required>
          <option value="">Select Room Type</option>
          <option value="SELF_CONTAINED">Self Contained</option>
          <option value="ONE_BEDROOM">One Bedroom</option>
          <option value="TWO_BEDROOM">Two Bedroom</option>
          <option value="STUDIO">Studio</option>
          <option value="SHARED_ROOM">Shared Room</option>
          <option value="SINGLE_ROOM">Single Room</option>
          <option value="OTHER">Other</option>
        </select>

        <label for="room_number">Room/Unit Number <span class="optional">(Optional)</span></label>
        <input type="text" id="room_number" placeholder="e.g., Room 101, Unit A, etc.">

        <label for="location">Location *</label>
        <select id="location" required>
          <option value="">Select Location</option>
          <!-- These options will be dynamically populated from the API -->
        </select>
        <div class="info-text">Loading locations...</div>

        <div class="buttons">
          <span></span>
          <button type="button" class="next-btn">Next</button>
        </div>
      </div>

      <!-- Step 2: Details & Pricing -->
      <div class="form-step">
        <h2>Details & Pricing</h2>

         <label for="price">First Price (₦) *</label>
        <input type="number" id="first_price" min="1000" step="0.01" placeholder="e.g., 500000" required>
        <label for="price">Annual Price (₦) *</label>
        <input type="number" id="price" min="1000" step="0.01" placeholder="e.g., 500000" required>
        <label for="price">First Price (₦) *</label>
        <input type="number" id="price" min="1000" step="0.01" placeholder="e.g., 500000" required>

        <label for="description">Description *</label>
        <textarea id="description"
          placeholder="Describe the lodge (features, condition, surroundings, facilities, etc.)" required></textarea>

        <label>Amenities <span class="optional">(Optional)</span></label>
        <div class="amenities-grid">
          <div class="amenity-option">
            <input type="checkbox" id="amenity_wifi" name="amenities" value="WiFi">
            <label for="amenity_wifi">WiFi</label>
          </div>
          <div class="amenity-option">
            <input type="checkbox" id="amenity_parking" name="amenities" value="Parking">
            <label for="amenity_parking">Parking</label>
          </div>
          <div class="amenity-option">
            <input type="checkbox" id="amenity_pool" name="amenities" value="Swimming Pool">
            <label for="amenity_pool">Swimming Pool</label>
          </div>
          <div class="amenity-option">
            <input type="checkbox" id="amenity_gym" name="amenities" value="Gym">
            <label for="amenity_gym">Gym</label>
          </div>
          <div class="amenity-option">
            <input type="checkbox" id="amenity_ac" name="amenities" value="Air Conditioning">
            <label for="amenity_ac">Air Conditioning</label>
          </div>
          <div class="amenity-option">
            <input type="checkbox" id="amenity_security" name="amenities" value="24/7 Security">
            <label for="amenity_security">24/7 Security</label>
          </div>
          <div class="amenity-option">
            <input type="checkbox" id="amenity_power" name="amenities" value="Power Backup">
            <label for="amenity_power">Power Backup</label>
          </div>
          <div class="amenity-option">
            <input type="checkbox" id="amenity_balcony" name="amenities" value="Balcony">
            <label for="amenity_balcony">Balcony</label>
          </div>
          <div class="amenity-option">
            <input type="checkbox" id="amenity_furnished" name="amenities" value="Furnished">
            <label for="amenity_furnished">Furnished</label>
          </div>
          <div class="amenity-option">
            <input type="checkbox" id="amenity_kitchen" name="amenities" value="Kitchen">
            <label for="amenity_kitchen">Kitchen</label>
          </div>
          <div class="amenity-option">
            <input type="checkbox" id="amenity_tv" name="amenities" value="TV">
            <label for="amenity_tv">TV</label>
          </div>
          <div class="amenity-option">
            <input type="checkbox" id="amenity_washer" name="amenities" value="Washing Machine">
            <label for="amenity_washer">Washing Machine</label>
          </div>
        </div>

        <label for="rules">House Rules <span class="optional">(Optional)</span></label>
        <textarea id="rules" placeholder="e.g., No smoking, No pets, Quiet hours 10pm-7am, etc."></textarea>

        <div class="buttons">
          <button type="button" class="prev-btn">Previous</button>
          <button type="button" class="next-btn">Next</button>
        </div>
      </div>

      <!-- Step 3: Contact & Media -->
      <div class="form-step">
        <h2>Contact & Media</h2>

        <div class="form-row">
          <div class="form-col">
            <label for="contact_phone">Contact Phone <span class="optional">(Optional)</span></label>
            <input type="tel" id="contact_phone" placeholder="e.g., 08012345678">
          </div>
          <div class="form-col">
            <label for="contact_email">Contact Email <span class="optional">(Optional)</span></label>
            <input type="email" id="contact_email" placeholder="e.g., contact@example.com">
          </div>
        </div>

        <label for="agency">Agency Name <span class="optional">(Optional)</span></label>
        <input type="text" id="agency" placeholder="If listing under an agency">

        <div class="availability-checkbox">
          <input type="checkbox" id="is_available" checked>
          <label for="is_available">This property is currently available</label>
        </div>

        <label for="video">Upload Video <span class="optional">(Optional)</span></label>
        <input type="file" id="video" accept="video/*">
        <div class="info-text">Supported formats: MP4, WebM</div>

        <label for="images">Upload Images *</label>
        <input type="file" id="images" accept="image/*" multiple required>
        <div class="info-text">Upload clear photos of the property. First image will be used as cover photo.</div>

        <div class="image-upload-container">
          <div class="image-preview-grid" id="imagePreviewContainer"></div>
        </div>

        <div class="buttons">
          <button type="button" class="prev-btn">Previous</button>
          <button type="submit" class="next-btn">Submit Listing</button>
        </div>
      </div>

    </form>
  </div>

  <!-- Validation Modal -->
  <div id="validationModal" class="modal">
    <div class="modal-content">
      <span id="closeModal" class="close">&times;</span>
      <p>Please fill all required fields in this step!</p>
    </div>
  </div>

  <footer class="footer">
    <p>© 2025 Book-It. Student housing made easy.</p>
  </footer>

  <script src="js/main.js"></script>
  <script src="js/config.js"></script>
  <script>
    // API Configuration
    const API_BASE_URL = CONFIG.API_BASE_URL;
    const LISTINGS_URL = `${API_BASE_URL}/api/listings/`;
    const TOKEN_REFRESH_URL = `${API_BASE_URL}/api/auth/token/refresh/`;

    // Token management functions
    function isTokenExpired() {
      const tokenExpiry = localStorage.getItem("tokenExpiry");
      if (!tokenExpiry) return true;
      return Date.now() > parseInt(tokenExpiry);
    }

    async function refreshAccessToken() {
      const refreshToken = localStorage.getItem("refreshToken");
      if (!refreshToken) {
        console.log("No refresh token available");
        return null;
      }

      try {
        console.log("Refreshing access token...");
        const response = await fetch(TOKEN_REFRESH_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ refresh: refreshToken })
        });

        if (!response.ok) {
          console.error("Token refresh failed:", response.status);
          return null;
        }

        const data = await response.json();
        console.log("Token refreshed successfully");

        // Store new access token
        localStorage.setItem("accessToken", data.access);

        // Set expiry (assuming 5 minutes = 300000 ms)
        localStorage.setItem("tokenExpiry", Date.now() + 300000);

        return data.access;
      } catch (error) {
        console.error("Token refresh error:", error);
        return null;
      }
    }

    async function getValidAccessToken() {
      let accessToken = localStorage.getItem("accessToken");

      // Check if token is expired
      if (isTokenExpired()) {
        console.log("Token is expired, refreshing...");
        accessToken = await refreshAccessToken();

        if (!accessToken) {
          // If refresh fails, clear tokens and redirect to login
          localStorage.removeItem("accessToken");
          localStorage.removeItem("refreshToken");
          localStorage.removeItem("tokenExpiry");
          showError("Your session has expired. Please login again.");
          setTimeout(() => {
            window.location.href = "login.html";
          }, 2000);
          return null;
        }
      }

      return accessToken;
    }

    // Load locations from Static Choices (Matching Backend)
    function loadLocations() {
      const locationSelect = document.getElementById('location');
      const infoText = locationSelect.nextElementSibling;

      // Updated to match the actual LOCATION_CHOICES from your Django model
      const locations = [
        { value: 'AROMA', label: 'Aroma' },
        { value: 'AMANSEA', label: 'Amansea' },
        { value: 'IFITE_ANAMBRA', label: 'Ifite Anambra' },
        { value: 'IFITE UP SCHOOL', label: 'Ifite Up School' },
        { value: 'IFITE DOWN SCHOOL', label: 'Ifite Down School' },
        { value: 'TEMP SITE', label: 'Temp Site' },
        { value: 'OTHER', label: 'Other' }
      ];

      locationSelect.innerHTML = '<option value="">Select Location</option>';

      locations.forEach(loc => {
        const option = document.createElement('option');
        option.value = loc.value;
        option.textContent = loc.label;
        locationSelect.appendChild(option);
      });

      infoText.textContent = "Locations loaded";
      infoText.style.color = "#28a745";
    }

    // Check authentication on page load
    function checkAuthentication() {
      const loggedInUser = localStorage.getItem("loggedInUser");
      const userRole = localStorage.getItem("userRole");
      const accessToken = localStorage.getItem("accessToken");
      const authWarning = document.getElementById("authWarning");

      console.log("Auth check:", { loggedInUser, userRole, hasToken: !!accessToken });

      if (!loggedInUser || userRole?.toLowerCase() !== "agent" || !accessToken) {
        authWarning.style.display = "block";
        // Disable form submission
        document.querySelectorAll('.next-btn, .prev-btn').forEach(btn => {
          btn.disabled = true;
          btn.style.opacity = "0.5";
          btn.style.cursor = "not-allowed";
        });
        return false;
      }

      authWarning.style.display = "none";
      return true;
    }

    // Initialize authentication check and load data
    document.addEventListener('DOMContentLoaded', async () => {
      if (!checkAuthentication()) {
        return;
      }

      // Try to get a valid token on load
      const validToken = await getValidAccessToken();
      if (!validToken) {
        showError("Please login again to post listings.");
        return;
      }

      // Load locations (Static) - Updated to match backend
      loadLocations();
    });

    const steps = document.querySelectorAll(".form-step");
    const nextBtns = document.querySelectorAll(".next-btn");
    const prevBtns = document.querySelectorAll(".prev-btn");
    const progressBar = document.getElementById("progressBar");
    let currentStep = 0;

    // Message elements
    const errorMessage = document.getElementById("error-message");
    const successMessage = document.getElementById("success-message");
    const loadingElement = document.getElementById("loading");

    // Modal elements
    const modal = document.getElementById("validationModal");
    const closeModal = document.getElementById("closeModal");
    closeModal.onclick = () => modal.style.display = "none";
    window.onclick = e => { if (e.target == modal) modal.style.display = "none"; }

    // Image preview array
    let uploadedImages = [];

    function updateStep() {
      steps.forEach((step, index) => step.classList.toggle("active", index === currentStep));
      progressBar.style.width = ((currentStep + 1) / steps.length * 100) + "%";
    }

    // Check required fields in current step
    function validateStep() {
      const inputs = steps[currentStep].querySelectorAll("input, select, textarea");
      for (let input of inputs) {
        if (input.hasAttribute("required") && !input.value.trim()) {
          modal.style.display = "block";
          return false;
        }
      }
      return true;
    }

    nextBtns.forEach(btn => btn.addEventListener("click", () => {
      if (validateStep() && currentStep < steps.length - 1) {
        currentStep++;
        updateStep();
      }
    }));

    prevBtns.forEach(btn => btn.addEventListener("click", () => {
      if (currentStep > 0) {
        currentStep--;
        updateStep();
      }
    }));

    // Multiple image upload with preview
    const imagesInput = document.getElementById("images");
    const imagePreviewContainer = document.getElementById("imagePreviewContainer");

    imagesInput.addEventListener("change", (e) => {
      const files = Array.from(e.target.files);

      // Clear previous previews
      imagePreviewContainer.innerHTML = "";
      uploadedImages = [];

      files.forEach((file, index) => {
        // Validate file type
        if (!file.type.startsWith('image/')) {
          showError(`File ${file.name} is not an image. Please select image files only.`);
          return;
        }

        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
          showError(`File ${file.name} is too large. Maximum size is 5MB.`);
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          // Create preview item
          const imageItem = document.createElement('div');
          imageItem.className = 'image-item';
          imageItem.innerHTML = `
            <img src="${e.target.result}" class="image-preview-item" alt="Preview ${index + 1}">
            <span class="remove-image" onclick="removeImage(${index})">×</span>
          `;
          imagePreviewContainer.appendChild(imageItem);

          // Store file data
          uploadedImages.push({
            file: file,
            dataUrl: e.target.result,
            name: file.name
          });
        };
        reader.readAsDataURL(file);
      });
    });

    // Remove image from preview
    window.removeImage = function (index) {
      uploadedImages.splice(index, 1);
      renderImagePreviews();
    };

    // Re-render image previews
    function renderImagePreviews() {
      imagePreviewContainer.innerHTML = "";
      uploadedImages.forEach((img, index) => {
        const imageItem = document.createElement('div');
        imageItem.className = 'image-item';
        imageItem.innerHTML = `
          <img src="${img.dataUrl}" class="image-preview-item" alt="Preview ${index + 1}">
          <span class="remove-image" onclick="removeImage(${index})">×</span>
        `;
        imagePreviewContainer.appendChild(imageItem);
      });
    }

    // Show/hide messages
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = "block";
      successMessage.style.display = "none";
    }

    function showSuccess(message) {
      successMessage.textContent = message;
      successMessage.style.display = "block";
      errorMessage.style.display = "none";
    }

    function hideMessages() {
      errorMessage.style.display = "none";
      successMessage.style.display = "none";
    }

    function setLoading(isLoading) {
      loadingElement.style.display = isLoading ? "block" : "none";
      // Disable all submit buttons during loading
      document.querySelectorAll('.next-btn[type="submit"]').forEach(btn => {
        btn.disabled = isLoading;
      });
    }

    // Get selected amenities as array
    function getSelectedAmenities() {
      const checkboxes = document.querySelectorAll('input[name="amenities"]:checked');
      const amenities = Array.from(checkboxes).map(cb => cb.value);
      return amenities;
    }

    // Form submit handler
    const form = document.getElementById("multiStepForm");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Get valid access token before submitting
      const accessToken = await getValidAccessToken();
      if (!accessToken) {
        showError("Authentication required. Please login again.");
        return;
      }

      // Check authentication again before submitting
      if (!checkAuthentication()) {
        showError("Please login as an agent to post listings.");
        return;
      }

      if (!validateStep()) {
        return;
      }

      // Check if at least one image is uploaded
      if (uploadedImages.length === 0) {
        showError("Please upload at least one image of the property.");
        return;
      }

      hideMessages();
      setLoading(true);

      try {
        // Get form data according to API schema
        const lodge_name = document.getElementById("lodge_name").value.trim();
        const location = document.getElementById("location").value;
        const room_type = document.getElementById("room_type").value;
        const total_rooms = parseInt(document.getElementById("total_rooms").value);
        const room_number = document.getElementById("room_number").value.trim() || null;
                const price = parseFloat(document.getElementById("first_price").value);
        const price = parseFloat(document.getElementById("price").value);
        const description = document.getElementById("description").value.trim();
        const amenities = getSelectedAmenities(); // This returns array of strings
        const rules = document.getElementById("rules").value.trim() || null;
        const contact_phone = document.getElementById("contact_phone").value.trim() || null;
        const contact_email = document.getElementById("contact_email").value.trim() || null;
        const agency = document.getElementById("agency").value.trim() || null;
        const is_available = document.getElementById("is_available").checked;
        const videoInput = document.getElementById("video");

        // Prepare FormData for multipart/form-data
        const formData = new FormData();

        // 1. Append simple fields
        formData.append("lodge_name", lodge_name);
        formData.append("description", description);
        formData.append("price", price.toFixed(2));
        formData.append("location", location);
        formData.append("room_type", room_type);
        formData.append("total_rooms", total_rooms);
        formData.append("is_available", is_available);

        if (room_number) formData.append("room_number", room_number);
        if (rules) formData.append("rules", rules);
        if (contact_phone) formData.append("contact_phone", contact_phone);
        if (contact_email) formData.append("contact_email", contact_email);
        if (agency) formData.append("agency", agency);

        // 2. Append Amenities as JSON string - KEY CHANGE: amenity_names instead of amenities
        if (amenities.length > 0) {
          // IMPORTANT: Use "amenity_names" as per your API serializer
          // Convert amenities array to JSON string
          const amenitiesJson = JSON.stringify(amenities);
          formData.append("amenity_names", amenitiesJson);
          console.log("Sending amenities as JSON:", amenitiesJson);
        }

        // 3. Append Files
        // Video
        if (videoInput && videoInput.files.length > 0) {
          formData.append("video", videoInput.files[0]);
        }

        // Add images - IMPORTANT: Use `uploaded_images` (plural) as per API
        uploadedImages.forEach((img, index) => {
          formData.append("uploaded_images", img.file, img.name || `image_${index}.jpg`);
        });

        console.log("Sending request to:", LISTINGS_URL);
        console.log("Form data entries:");
        for (let [key, value] of formData.entries()) {
          console.log(`${key}:`, value);
        }

        // Send POST request
        const response = await fetch(LISTINGS_URL, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            // Don't set Content-Type for FormData - browser will set it with boundary
          },
          body: formData
        });

        console.log("Response status:", response.status);

        // Try to parse response
        let data;
        try {
          const text = await response.text();
          console.log("Response text:", text.substring(0, 500));
          data = text ? JSON.parse(text) : {};
        } catch (parseError) {
          console.error("Error parsing response:", parseError);
          throw new Error(`Server returned: ${response.status} ${response.statusText}`);
        }

        if (!response.ok) {
          // Handle errors
          let errorMsg = "Failed to create listing. ";

          if (response.status === 400) {
            // Validation errors
            if (data.detail) {
              errorMsg += data.detail;
            } else if (data.non_field_errors) {
              errorMsg += data.non_field_errors.join(', ');
            } else if (data.uploaded_images) {
              errorMsg += "Image upload error.";
            } else if (data.amenity_names) {
              errorMsg += `Amenities error: ${Array.isArray(data.amenity_names) ? data.amenity_names.join(', ') : data.amenity_names}`;
            } else {
              // Show field-specific errors
              const fieldErrors = [];
              Object.keys(data).forEach(key => {
                if (Array.isArray(data[key])) {
                  fieldErrors.push(`${key}: ${data[key].join(', ')}`);
                } else if (typeof data[key] === 'string') {
                  fieldErrors.push(`${key}: ${data[key]}`);
                }
              });
              if (fieldErrors.length > 0) {
                errorMsg += fieldErrors.join('; ');
              } else {
                errorMsg += "Validation error. Please check your input.";
              }
            }
          } else if (response.status === 401) {
            errorMsg = "Session expired. Please login again.";
          } else if (response.status === 403) {
            errorMsg = "You don't have permission to create listings. Please ensure you're registered as an agent.";
          } else {
            errorMsg += `Server error: ${response.status}`;
          }

          throw new Error(errorMsg);
        }

        // Success
        console.log("Listing created successfully:", data);
        showSuccess("Listing posted successfully! Redirecting to homepage...");

        // Clear form
        form.reset();
        uploadedImages = [];
        imagePreviewContainer.innerHTML = "";

        // Reset selects to default
        document.getElementById('location').selectedIndex = 0;
        document.getElementById('room_type').selectedIndex = 0;

        // Uncheck all amenities checkboxes
        document.querySelectorAll('input[name="amenities"]:checked').forEach(cb => {
          cb.checked = false;
        });

        // Reset availability checkbox
        document.getElementById('is_available').checked = true;

        // Redirect after 2 seconds
        setTimeout(() => {
          window.location.href = "index.html";
        }, 2000);

      } catch (err) {
        console.error("Error creating listing:", err);

        let errorMessageText = err.message || "Something went wrong while creating the listing.";

        // Check for CORS errors
        if (err.name === 'TypeError' && err.message.includes('Failed to fetch')) {
          errorMessageText = "Cannot connect to the server. Please check your internet connection and try again.";
        }

        showError(errorMessageText);
      } finally {
        setLoading(false);
      }
    });

    // Initialize
    updateStep();

    // Debug: Log current user info
    console.log("Current user info:", {
      loggedIn: localStorage.getItem("loggedInUser"),
      role: localStorage.getItem("userRole"),
      hasToken: !!localStorage.getItem("accessToken"),
      userName: localStorage.getItem("userName"),
      userEmail: localStorage.getItem("userEmail")
    });
  </script>

</body>

</html>