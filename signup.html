<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Signup</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: "Segoe UI", Arial, sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, #0a7cff, #005bd1);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .auth-box {
      background: #fff;
      width: 100%;
      max-width: 380px;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.5s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .auth-box h2 {
      text-align: center;
      margin-bottom: 10px;
      color: #0a7cff;
    }

    .auth-box input,
    .auth-box select {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 15px;
    }

    .auth-box input:focus,
    .auth-box select:focus {
      outline: none;
      border-color: #0a7cff;
    }

    .auth-box #signup-btn {
      width: 100%;
      padding: 12px;
      background: #0a7cff;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .auth-box #signup-btn:hover {
      background: #055ec2;
    }

    /* Google Sign In Button Styles */
    .google-btn {
      width: 100%;
      padding: 12px;
      background: #fff;
      color: #333;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      margin-bottom: 15px;
    }

    .google-btn:hover {
      background: #f8f9fa;
      border-color: #ccc;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .google-btn img {
      width: 18px;
      height: 18px;
    }

    .divider {
      display: flex;
      align-items: center;
      margin: 20px 0;
      color: #666;
      font-size: 14px;
    }

    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      border-bottom: 1px solid #ddd;
    }

    .divider span {
      padding: 0 15px;
    }

    .auth-footer {
      text-align: center;
      margin-top: 15px;
      font-size: 14px;
    }

    .auth-footer a {
      color: #0a7cff;
      text-decoration: none;
      font-weight: 600;
    }

    .auth-footer a:hover {
      text-decoration: underline;
    }

    .loading {
      display: none;
      text-align: center;
      color: #0a7cff;
      margin: 10px 0;
    }

    .error-message {
      display: none;
      background: #ffebee;
      color: #c62828;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 14px;
      white-space: pre-wrap;
    }

    /* Password field container - fixed */
    .password-field {
      position: relative;
      /* margin-bottom: 15px; */
    }

    /* .password-field input {
      width: 100%;
      padding-right: 40px;
      margin-bottom: 0;
    } */

    .password-toggle {
      position: absolute;
      right: 2px;
      top: 35%;
      transform: translateY(-50%);
      border: none;
      cursor: pointer;
      padding: 5px;
      color: #666;
      font-size: 14px;
      text-align: right;
    }

    button.password-toggle {
      background-color: transparent;

    }

    .password-toggle:hover {
      color: #9c9b9b;
      background-color: transparent;

    }

    .password-toggle svg {
      display: block;
      width: 20px;
      height: 20px;
    }

    @media (max-width: 480px) {
      .auth-box {
        margin: 0 15px;
        padding: 25px;
      }

      body {
        padding: 20px;
      }
    }
  </style>
</head>

<body>
  <div class="auth-box">
    <h2>Create Account</h2>

    <div class="error-message" id="error-message"></div>
    <div class="loading" id="loading">Creating account...</div>

    <input type="text" id="full_name" placeholder="Full Name" required>
    <input type="email" id="email" placeholder="Email address" required>

    <!-- Password with visibility toggle -->
    <div class="password-field">
      <input type="password" id="password1" placeholder="Password" required>
      <button type="button" class="password-toggle" onclick="togglePasswordVisibility('password1', this)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        </svg>
      </button>
    </div>

    <!-- Confirm Password with visibility toggle -->
    <div class="password-field">
      <input type="password" id="password2" placeholder="Confirm Password" required>
      <button type="button" class="password-toggle" onclick="togglePasswordVisibility('password2', this)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        </svg>
      </button>
    </div>

    <input type="tel" id="phone_number" placeholder="Phone Number" required>

    <!-- Removed Agent option -->
    <!-- <select id="role" required>
      <option value="">Select Role</option>
      <option value="lodger">Lodger</option>
    </select> -->

    <button onclick="signup()" id="signup-btn" class="SignUp">Sign Up</button>

    <!-- Divider between regular signup and Google signup -->
    <div class="divider">
      <span>OR</span>
    </div>

    <!-- Google Sign In Button -->
    <button class="google-btn" onclick="signInWithGoogle()">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24px" height="24px">
        <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z" />
        <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z" />
        <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z" />
        <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z" />
      </svg>
      Continue with Google
    </button>

    <div class="auth-footer">
      Already have an account? <a href="login.html">Login</a>
    </div>
  </div>

  <script src="js/config.js"></script>
  <script>
    // API endpoints
    const REGISTRATION_URL = `${CONFIG.API_BASE_URL}/api/auth/registration/`;
    const GOOGLE_AUTH_URL = `${CONFIG.API_BASE_URL}/api/auth/google/`;

    // Password visibility toggle function
    function togglePasswordVisibility(passwordFieldId, toggleButton) {
      const passwordField = document.getElementById(passwordFieldId);
      const isPasswordVisible = passwordField.type === 'text';

      // Toggle the input type
      passwordField.type = isPasswordVisible ? 'password' : 'text';

      // Update the icon
      const svg = toggleButton.querySelector('svg');
      if (isPasswordVisible) {
        // Show eye (visible)
        svg.innerHTML = `
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        `;
        toggleButton.setAttribute('aria-label', 'Show password');
      } else {
        // Show eye-slash (hidden)
        svg.innerHTML = `
          <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
          <line x1="1" y1="1" x2="23" y2="23"></line>
        `;
        toggleButton.setAttribute('aria-label', 'Hide password');
      }
    }

    // Show error message
    function showError(message) {
      const errorEl = document.getElementById("error-message");
      errorEl.textContent = message;
      errorEl.style.display = "block";
    }

    // Hide error message
    function hideError() {
      document.getElementById("error-message").style.display = "none";
    }

    // Show loading state
    function setLoading(isLoading) {
      document.getElementById("loading").style.display = isLoading ? "block" : "none";
      document.getElementById("signup-btn").disabled = isLoading;
    }

    // Function to handle Google Sign In
function signInWithGoogle() {
    const clientId = "YOUR_GOOGLE_CLIENT_ID"; 
    const redirectUri = "https://bookit-ecru-sigma.vercel.app"; // Must match Google Console
    const scope = "openid email profile";
    
    const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
        `client_id=${clientId}&` +
        `redirect_uri=${encodeURIComponent(redirectUri)}&` +
        `response_type=code&` +
        `scope=${encodeURIComponent(scope)}&` +
        `access_type=offline&prompt=consent`;

    window.location.href = authUrl;
}
    
async function exchangeCodeForToken() {
    const code = new URLSearchParams(window.location.search).get('code');
    if (code) {
        const response = await fetch("https://bookit-api-tpvz.onrender.com", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ code: code })
        });
        const data = await response.json();
        // Save the received token (e.g., localStorage.setItem('token', data.key))
    }
}
// Signup function with better error handling
    window.signup = async function () {
      hideError();
      setLoading(true);

      const email = document.getElementById("email").value.trim();
      const full_name = document.getElementById("full_name").value.trim();
      const password1 = document.getElementById("password1").value;
      const password2 = document.getElementById("password2").value;
      const phone_number = document.getElementById("phone_number").value.trim();
      const role = "lodger"; // Always lodger since agent signup is removed

      // Validation
      if (!email || !full_name || !password1 || !password2 || !phone_number) {
        showError("Please fill in all required fields");
        setLoading(false);
        return;
      }

      if (password1 !== password2) {
        showError("Passwords do not match");
        setLoading(false);
        return;
      }

      if (password1.length < 8) {
        showError("Password must be at least 8 characters long");
        setLoading(false);
        return;
      }

      // Prepare request data based on API schema
      const requestData = {
        email: email,
        password1: password1,
        password2: password2,
        full_name: full_name,
        phone_number: phone_number,
        is_agent: false  // Always false now since agent signup is removed
      };

      try {
        console.log("Sending request to:", REGISTRATION_URL);
        console.log("Request data:", requestData);

        const response = await fetch(REGISTRATION_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
          },
          body: JSON.stringify(requestData)
        });

        console.log("Response status:", response.status);

        // Get response text first to handle both JSON and text responses
        const responseText = await response.text();
        let data = {};

        try {
          if (responseText) {
            data = JSON.parse(responseText);
          }
        } catch (parseError) {
          console.log("Could not parse response as JSON, using text");
          data = { detail: responseText || "No response body" };
        }

        if (!response.ok) {
          // Handle different types of errors
          let errorMsg = "Registration failed. ";

          if (response.status === 400) {
            // Bad Request - usually validation errors
            if (data.email) {
              errorMsg += `Email: ${Array.isArray(data.email) ? data.email.join(', ') : data.email} `;
            }
            if (data.password1) {
              errorMsg += `Password: ${Array.isArray(data.password1) ? data.password1.join(', ') : data.password1} `;
            }
            if (data.non_field_errors) {
              errorMsg += Array.isArray(data.non_field_errors) ? data.non_field_errors.join(', ') : data.non_field_errors;
            }
            if (errorMsg === "Registration failed. " && data.detail) {
              errorMsg += data.detail;
            }
          } else if (response.status === 405) {
            errorMsg = "Method not allowed. Please contact the API administrator.";
          } else if (data.detail) {
            errorMsg += data.detail;
          } else if (responseText) {
            errorMsg += responseText;
          } else {
            errorMsg += `Server returned: ${response.status} ${response.statusText}`;
          }

          throw new Error(errorMsg);
        }

        // Success - Show verification message instead of auto-login
        console.log("Registration successful:", data);

        // Clear the form
        document.getElementById("full_name").value = "";
        document.getElementById("email").value = "";
        document.getElementById("password1").value = "";
        document.getElementById("password2").value = "";
        document.getElementById("phone_number").value = "";

        // Show success message about email verification
        showVerificationMessage(email);

      } catch (err) {
        console.error("Registration error:", err);

        // Enhanced error message
        let errorMessage = err.message || "Something went wrong during registration!";

        // Check for CORS errors
        if (err.name === 'TypeError' && err.message.includes('Failed to fetch')) {
          errorMessage = "Cannot connect to the server. This may be due to:\n\n" +
            "• Network connectivity issues\n" +
            "• Server is down\n" +
            "• CORS restrictions (try using a CORS extension for development)";
        }

        showError(errorMessage);
      } finally {
        setLoading(false);
      }
    }

    // Function to show verification instructions
    function showVerificationMessage(email) {
      const authBox = document.querySelector('.auth-box');
      authBox.innerHTML = `
        <h2>Verify Your Email</h2>
        <div style="text-align: center; padding: 20px;">
          <div style="font-size: 48px; color: #0a7cff; margin-bottom: 20px;">✉️</div>
          <h3>Almost Done!</h3>
          <p>We've sent a verification email to:</p>
          <div class="email-display" style="background: #f5f9ff; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <strong>${email}</strong>
          </div>
          <p>Click the link in the email to verify your account.</p>
          <p><small>Didn't receive it? Check your spam folder.</small></p>
          <div style="margin: 30px 0;">
            <button onclick="resendVerificationEmail('${email}')" class="btn">
              Resend Verification Email
            </button>
            <button onclick="window.location.href='login.html'" class="btn btn-secondary">
              Go to Login
            </button>
          </div>
          <p style="font-size: 12px; color: #666; margin-top: 20px;">
            Verification link expires in 24 hours
          </p>
        </div>
      `;
    }

    // Function to resend verification email
    async function resendVerificationEmail(email) {
      try {
        const response = await fetch(`${CONFIG.API_BASE_URL}/api/auth/registration/resend-email/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email: email })
        });
        
        const responseText = await response.text();
        let data = {};
        
        try {
          if (responseText) {
            data = JSON.parse(responseText);
          }
        } catch (parseError) {
          console.log("Could not parse response as JSON");
        }
        
        if (response.ok) {
          alert("✓ Verification email resent! Please check your inbox.");
        } else {
          let errorMsg = "Failed to resend verification email.";
          if (data.detail) {
            errorMsg += ` Error: ${data.detail}`;
          }
          alert(errorMsg);
        }
      } catch (error) {
        console.error("Resend error:", error);
        alert("Failed to resend verification email. Please try again later.");
      }
    }

    // Add form submission on Enter key
    document.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        signup();
      }
    });
  </script>
</body>

</html>