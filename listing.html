<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>My Listings | Book-It</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* Additional styles for My Listings page */
    .page-header {
      text-align: center;
      padding: 40px 20px;
      background: white;
      color: #cccccc;
    }

    .page-header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .page-header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    /* Card actions styling - ALWAYS VISIBLE */
    .card-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    .edit-btn,
    .delete-btn {
      flex: 1;
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.95rem;
    }

    .edit-btn {
      background: #0a7cff;
      color: white;
    }

    .edit-btn:hover {
      background: #055ec2;
    }

    .delete-btn {
      background: #ff4757;
      color: white;
    }

    .delete-btn:hover {
      background: #d63031;
    }

    /* No listings message */
    .no-listings {
      grid-column: 1 / -1;
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      margin: 20px auto;
      max-width: 600px;
    }

    .no-listings h3 {
      color: #666;
      margin-bottom: 15px;
      font-size: 1.5rem;
    }

    .no-listings p {
      color: #888;
      margin-bottom: 25px;
    }

    .post-listing-btn {
      display: inline-block;
      background: #0a7cff;
      color: white;
      padding: 12px 30px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
      transition: background 0.3s;
      border: none;
      cursor: pointer;
      font-size: 1rem;
    }

    .post-listing-btn:hover {
      background: #055ec2;
    }

    /* Loading state */
    .loading {
      text-align: center;
      padding: 50px;
      color: #0a7cff;
      font-size: 1.1rem;
      grid-column: 1 / -1;
    }

    /* EDIT MODAL STYLES */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .edit-modal {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h2 {
      margin: 0;
      color: #222;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-modal:hover {
      color: #ff4757;
    }

    .modal-form label {
      display: block;
      margin-top: 15px;
      font-weight: 500;
      font-size: 14px;
      color: #333;
    }

    .modal-form input,
    .modal-form select,
    .modal-form textarea {
      width: 100%;
      padding: 12px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 15px;
      outline: none;
      box-sizing: border-box;
    }

    .modal-form textarea {
      resize: vertical;
      min-height: 80px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }

    .modal-buttons button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 15px;
    }

    .cancel-btn {
      background: #ddd;
      color: #333;
    }

    .cancel-btn:hover {
      background: #ccc;
    }

    .save-btn {
      background: #0a7cff;
      color: white;
    }

    .save-btn:hover {
      background: #055ec2;
    }

    .save-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .modal-loading {
      display: none;
      text-align: center;
      color: #0a7cff;
      margin: 10px 0;
    }

    .modal-error {
      display: none;
      background: #ffebee;
      color: #c62828;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 14px;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .page-header h1 {
        font-size: 2rem;
      }

      .page-header {
        padding: 30px 15px;
      }

      .edit-modal {
        width: 95%;
        padding: 20px;
        margin: 10px;
      }

      .modal-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>

  <!-- NAVBAR -->
  <header class="navbar">
    <a href="index.html" class="logo">
      <img src="logo.png" alt="Book-It Logo">
    </a>

    <!-- Desktop Menu -->
    <nav class="menu-panel desktop-nav" id="navMenu">
      <a href="index.html">Home</a>
      <a href="contact.html">Contact/Support</a>
      <a href="post.html" id="postLink">Post Lodge</a>
      <div class="user-area" id="userArea"></div>
    </nav>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">☰</button>

    <!-- Mobile Menu -->
    <nav class="menu-panel mobile-nav" id="mobileNav"></nav>
  </header>

  <!-- Page Header -->
  <section class="page-header">
    <h1>My Listings</h1>
    <p>Manage your property listings</p>
  </section>

  <!-- LISTINGS -->
  <section class="listings-container" id="listingsContainer">
    <div class="loading">Loading your listings...</div>
  </section>

  <!-- EDIT MODAL -->
  <div class="modal-overlay" id="editModal">
    <div class="edit-modal">
      <div class="modal-header">
        <h2>Edit Listing</h2>
        <button class="close-modal" onclick="closeEditModal()">×</button>
      </div>

      <div class="modal-error" id="modalError"></div>
      <div class="modal-loading" id="modalLoading">Updating listing...</div>

      <form class="modal-form" id="editForm">
        <label for="editTitle">Lodge Name</label>
        <input type="text" id="editTitle" required>

        <label for="editLocation">Location</label>
        <select id="editLocation" required>
          <option value="">Select Location</option>
          <option value="Ifite-Up school">Ifite-Up School</option>
          <option value="Ifite-Down school">Ifite-Down School</option>
          <option value="Amansea">Amansea</option>
          <option value="Temp Site">Temp Site</option>
          <option value="Aroma">Aroma</option>
        </select>

        <label for="editBedrooms">Number of Bedrooms</label>
        <input type="number" id="editBedrooms" min="1" required>

        <label for="editBathrooms">Number of Bathrooms</label>
        <input type="number" id="editBathrooms" min="1" required>

        <label for="editPrice">Annual Price (₦)</label>
        <input type="number" id="editPrice" min="1000" step="0.01" required>

        <label for="editDescription">Description</label>
        <textarea id="editDescription" required></textarea>

        <div class="modal-buttons">
          <button type="button" class="cancel-btn" onclick="closeEditModal()">Cancel</button>
          <button type="submit" class="save-btn" id="saveBtn">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="footer">
    <p>© 2025 Book-It. Student housing made easy.</p>
  </footer>

  <script src="js/main.js"></script>

  <script>
    const API_BASE = "https://bookit-api-tpvz.onrender.com/api";
    let currentEditingListingId = null;

    // Check if user is logged in and is an agent
    document.addEventListener("DOMContentLoaded", async () => {
      const userName = localStorage.getItem("userName");
      const userRole = localStorage.getItem("userRole");
      const userEmail = localStorage.getItem("userEmail");
      const userId = localStorage.getItem("userId");

      if (!userName || userRole?.toLowerCase() !== 'agent') {
        window.location.href = "login.html";
        return;
      }

      // Load agent's listings
      try {
        await loadAgentListings(userId);
      } catch (error) {
        console.error("Error loading listings:", error);
        showErrorMessage("Failed to load your listings. Please try again later.");
      }
    });

    // Load agent's listings from API
    async function loadAgentListings(userId) {
      const container = document.getElementById("listingsContainer");

      try {
        // Fetch all listings
        const response = await fetch(`${API_BASE}/listings/`);

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const allListings = await response.json();

        // Filter listings for the current agent using created_by field
        const myListings = allListings.filter(listing => {
          return listing.created_by == userId;
        });

        console.log("All listings:", allListings);
        console.log("My listings (filtered):", myListings);
        console.log("Current user ID:", userId);

        if (myListings.length === 0) {
          showNoListingsMessage();
          return;
        }

        renderListings(myListings);

      } catch (error) {
        console.error("Error fetching listings:", error);
        showErrorMessage("Failed to load listings. Please try again.");
      }
    }

    // Render listings with edit/delete buttons
    function renderListings(listings) {
      const container = document.getElementById("listingsContainer");
      container.innerHTML = "";

      listings.forEach(listing => {
        const card = document.createElement("div");
        card.className = "listing-card";

        // Get the first image URL from the images array
        let imageUrl = 'https://via.placeholder.com/400';
        if (listing.images && listing.images.length > 0 && listing.images[0].image) {
          imageUrl = listing.images[0].image;
        } else if (listing.cover_image_url) {
          imageUrl = listing.cover_image_url;
        }

        card.innerHTML = `
          <img src="${imageUrl}" alt="${listing.title}" onerror="this.src='https://via.placeholder.com/400'">
          <div class="card-body">
            <h5>${listing.title}</h5>
            <p>${listing.location || 'Location not specified'}</p>
            <p class="price">₦${Number(listing.price || 0).toLocaleString()}</p>
            <p><small>Bedrooms: ${listing.bedrooms || 0} | Bathrooms: ${listing.bathrooms || 0}</small></p>
            <div class="card-actions">
              <button class="edit-btn" onclick="openEditModal('${listing.id}')">Edit</button>
              <button class="delete-btn" onclick="deleteListing('${listing.id}')">Delete</button>
            </div>
          </div>
        `;

        container.appendChild(card);
      });
    }

    // Show no listings message
    function showNoListingsMessage() {
      const container = document.getElementById("listingsContainer");
      container.innerHTML = `
        <div class="no-listings">
          <h3>No Listings Found</h3>
          <p>You haven't posted any listings yet. Start by posting your first property!</p>
          <a href="post.html" class="post-listing-btn">Post a Listing</a>
        </div>
      `;
    }

    // Show error message
    function showErrorMessage(message) {
      const container = document.getElementById("listingsContainer");
      container.innerHTML = `
        <div class="no-listings">
          <h3>Error Loading Listings</h3>
          <p>${message}</p>
          <button onclick="location.reload()" class="post-listing-btn" style="cursor:pointer;">Retry</button>
        </div>
      `;
    }

    // Open edit modal and load listing data
    window.openEditModal = async function (listingId) {
      currentEditingListingId = listingId;

      try {
        // Fetch listing details
        const response = await fetch(`${API_BASE}/listings/${listingId}/`);

        if (!response.ok) {
          throw new Error(`Failed to fetch listing: ${response.status}`);
        }

        const listing = await response.json();

        // Populate form fields
        document.getElementById('editTitle').value = listing.title || '';
        document.getElementById('editLocation').value = listing.location || '';
        document.getElementById('editBedrooms').value = listing.bedrooms || 1;
        document.getElementById('editBathrooms').value = listing.bathrooms || 1;
        document.getElementById('editPrice').value = parseFloat(listing.price) || 1000;
        document.getElementById('editDescription').value = listing.description || '';

        // Show modal
        document.getElementById('editModal').classList.add('active');
        document.getElementById('modalError').style.display = 'none';

      } catch (error) {
        console.error("Error loading listing for edit:", error);
        showModalError("Failed to load listing details. Please try again.");
      }
    }

    // Close edit modal
    window.closeEditModal = function () {
      document.getElementById('editModal').classList.remove('active');
      currentEditingListingId = null;
      document.getElementById('editForm').reset();
      document.getElementById('modalError').style.display = 'none';
    }

    // Show modal error
    function showModalError(message) {
      const errorEl = document.getElementById('modalError');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }

    // Hide modal error
    function hideModalError() {
      document.getElementById('modalError').style.display = 'none';
    }

    // Set modal loading state
    function setModalLoading(isLoading) {
      document.getElementById('modalLoading').style.display = isLoading ? 'block' : 'none';
      document.getElementById('saveBtn').disabled = isLoading;
    }

    // Handle edit form submission
    document.getElementById('editForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      if (!currentEditingListingId) {
        showModalError("No listing selected for editing.");
        return;
      }

      // Get form data
      const title = document.getElementById('editTitle').value.trim();
      const location = document.getElementById('editLocation').value;
      const bedrooms = parseInt(document.getElementById('editBedrooms').value);
      const bathrooms = parseInt(document.getElementById('editBathrooms').value);
      const price = parseFloat(document.getElementById('editPrice').value);
      const description = document.getElementById('editDescription').value.trim();

      // Validation
      if (!title || !location || !bedrooms || !bathrooms || !price || !description) {
        showModalError("Please fill in all required fields.");
        return;
      }

      if (price < 1000) {
        showModalError("Price must be at least ₦1000.");
        return;
      }

      hideModalError();
      setModalLoading(true);

      try {
        // Get access token
        const accessToken = localStorage.getItem('accessToken');

        if (!accessToken) {
          showModalError("Session expired. Please login again.");
          setModalLoading(false);
          return;
        }

        // Prepare update data
        const updateData = {
          title: title,
          location: location,
          bedrooms: bedrooms,
          bathrooms: bathrooms,
          price: price.toFixed(2),
          description: description
        };

        console.log("Updating listing:", currentEditingListingId);
        console.log("Update data:", updateData);

        // Send PUT request
        const response = await fetch(`${API_BASE}/listings/${currentEditingListingId}/`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`,
            'Accept': 'application/json'
          },
          body: JSON.stringify(updateData)
        });

        console.log("Update response status:", response.status);

        let data;
        try {
          const text = await response.text();
          data = text ? JSON.parse(text) : {};
        } catch (parseError) {
          console.error("Error parsing response:", parseError);
          throw new Error(`Server error: ${response.status}`);
        }

        if (!response.ok) {
          let errorMsg = "Failed to update listing. ";

          if (response.status === 400) {
            if (data.detail) {
              errorMsg += data.detail;
            } else if (data.non_field_errors) {
              errorMsg += data.non_field_errors.join(', ');
            } else {
              // Show field-specific errors
              const fieldErrors = [];
              Object.keys(data).forEach(key => {
                if (Array.isArray(data[key])) {
                  fieldErrors.push(`${key}: ${data[key].join(', ')}`);
                }
              });
              if (fieldErrors.length > 0) {
                errorMsg += fieldErrors.join('; ');
              } else {
                errorMsg += "Validation error.";
              }
            }
          } else if (response.status === 401) {
            errorMsg = "Session expired. Please login again.";
          } else if (response.status === 403) {
            errorMsg = "You don't have permission to edit this listing.";
          } else if (response.status === 404) {
            errorMsg = "Listing not found.";
          } else {
            errorMsg += `Server error: ${response.status}`;
          }

          throw new Error(errorMsg);
        }

        // Success
        console.log("Listing updated successfully:", data);

        // Close modal
        closeEditModal();

        // Reload listings
        const userId = localStorage.getItem('userId');
        await loadAgentListings(userId);

        alert("Listing updated successfully!");

      } catch (error) {
        console.error("Error updating listing:", error);
        showModalError(error.message || "Failed to update listing. Please try again.");
      } finally {
        setModalLoading(false);
      }
    });

    // Delete listing function
    window.deleteListing = async function (listingId) {
      if (!confirm("Are you sure you want to delete this listing? This action cannot be undone.")) {
        return;
      }

      try {
        // Get access token
        const accessToken = localStorage.getItem("accessToken");

        if (!accessToken) {
          alert("Please login again to delete listings.");
          window.location.href = "login.html";
          return;
        }

        // API delete request
        const response = await fetch(`${API_BASE}/listings/${listingId}/`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          if (response.status === 401) {
            alert("Session expired. Please login again.");
            window.location.href = "login.html";
            return;
          }
          throw new Error(`Failed to delete listing: ${response.status}`);
        }

        // Success - reload listings
        const userId = localStorage.getItem("userId");
        await loadAgentListings(userId);

        alert("Listing deleted successfully!");

      } catch (error) {
        console.error("Error deleting listing:", error);
        alert("Failed to delete listing. Please try again.");
      }
    }

    // Close modal when clicking outside
    document.getElementById('editModal').addEventListener('click', function (e) {
      if (e.target === this) {
        closeEditModal();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && document.getElementById('editModal').classList.contains('active')) {
        closeEditModal();
      }
    });

    // Logout function
    window.logout = function () {
      localStorage.clear();
      window.location.href = "login.html";
    }

    // Mobile menu functionality (same as home page)
    const mobileMenuBtn = document.getElementById("mobileMenuBtn");
    const desktopNav = document.getElementById("navMenu");

    if (mobileMenuBtn && desktopNav) {
      mobileMenuBtn.addEventListener("click", () => desktopNav.classList.toggle("active"));
    }
  </script>

</body>

</html>