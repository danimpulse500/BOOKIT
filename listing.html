<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>My Listings | Book-It</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* Additional styles for My Listings page */
    .page-header {
      text-align: center;
      padding: 40px 20px;
      /* background: linear-gradient(135deg, #0a7cff, #005bd1); */
      background: white;
      color: #cccccc;
    }

    .page-header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .page-header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    /* Card actions styling */
    .card-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    .edit-btn,
    .delete-btn {
      flex: 1;
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.95rem;
    }

    .edit-btn {
      background: #0a7cff;
      color: white;
    }

    .edit-btn:hover {
      background: #055ec2;
    }

    .delete-btn {
      background: #ff4757;
      color: white;
    }

    .delete-btn:hover {
      background: #d63031;
    }

    /* No listings message */
    .no-listings {
      grid-column: 1 / -1;
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      margin: 20px auto;
      max-width: 600px;
    }

    .no-listings h3 {
      color: #666;
      margin-bottom: 15px;
      font-size: 1.5rem;
    }

    .no-listings p {
      color: #888;
      margin-bottom: 25px;
    }

    .post-listing-btn {
      display: inline-block;
      background: #0a7cff;
      color: white;
      padding: 12px 30px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
      transition: background 0.3s;
      border: none;
      cursor: pointer;
      font-size: 1rem;
    }

    .post-listing-btn:hover {
      background: #055ec2;
    }

    /* Loading state */
    .loading {
      text-align: center;
      padding: 50px;
      color: #0a7cff;
      font-size: 1.1rem;
      grid-column: 1 / -1;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .page-header h1 {
        font-size: 2rem;
      }

      .page-header {
        padding: 30px 15px;
      }
    }
  </style>
</head>

<body>

  <!-- NAVBAR -->
  <header class="navbar">
    <a href="index.html" class="logo">
      <img src="logo.png" alt="Book-It Logo">
    </a>

    <!-- Desktop Menu -->
    <nav class="menu-panel desktop-nav" id="navMenu">
      <a href="index.html">Home</a>
      <a href="contact.html">Contact/Support</a>
      <a href="post.html" id="postLink">Post Lodge</a>
      <div class="user-area" id="userArea"></div>
    </nav>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">☰</button>

    <!-- Mobile Menu -->
    <nav class="menu-panel mobile-nav" id="mobileNav"></nav>
  </header>

  <!-- Page Header -->
  <section class="page-header">
    <h1>My Listings</h1>
    <p>Manage your property listings</p>
  </section>

  <!-- LISTINGS -->
  <section class="listings-container" id="listingsContainer">
    <div class="loading">Loading your listings...</div>
  </section>

  <!-- FOOTER -->
  <footer class="footer">
    <p>© 2025 Book-It. Student housing made easy.</p>
  </footer>

  <script src="js/main.js"></script>
  <script src="js/config.js"></script>

  <script>
    const API_BASE = `${CONFIG.API_BASE_URL}/api`;

    // Check if user is logged in and is an agent
    document.addEventListener("DOMContentLoaded", async () => {
      const userName = localStorage.getItem("userName");
      const userRole = localStorage.getItem("userRole");
      const userEmail = localStorage.getItem("userEmail");

      if (!userName || userRole?.toLowerCase() !== 'agent') {
        window.location.href = "login.html";
        return;
      }

      // Update user area in navbar - Handled by main.js


      // Load agent's listings
      try {
        await loadAgentListings(userEmail);
      } catch (error) {
        console.error("Error loading listings:", error);
        showErrorMessage("Failed to load your listings. Please try again later.");
      }
    });

    // Load agent's listings from API
    async function loadAgentListings(agentEmail) {
      const container = document.getElementById("listingsContainer");

      try {
        // Fetch all listings
        const response = await fetch(`${API_BASE}/listings/`);

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const allListings = await response.json();
        const userName = localStorage.getItem("userName");

        // Filter listings for the current agent
        // Adjust this filter based on your API structure
        const myListings = allListings.filter(listing => {
          // Try different possible agent identifier fields
          return listing.agent_name === userName ||
            listing.agent === userName ||
            listing.agent_email === agentEmail ||
            listing.owner === userName;
        });

        if (myListings.length === 0) {
          showNoListingsMessage();
          return;
        }

        renderListings(myListings);

      } catch (error) {
        console.error("Error fetching listings:", error);

        // Fallback to localStorage if API fails
        const localListings = JSON.parse(localStorage.getItem("listings")) || [];
        const filteredListings = localListings.filter(listing =>
          listing.agentName === localStorage.getItem("userName")
        );

        if (filteredListings.length > 0) {
          renderListings(filteredListings);
        } else {
          showNoListingsMessage();
        }
      }
    }

    // Render listings with edit/delete buttons
    function renderListings(listings) {
      const container = document.getElementById("listingsContainer");
      container.innerHTML = "";

      listings.forEach(listing => {
        const card = document.createElement("div");
        card.className = "listing-card";

        // Get the first image URL from the images array
        let imageUrl = 'https://via.placeholder.com/400';
        if (listing.images && listing.images.length > 0 && listing.images[0].image) {
          imageUrl = listing.images[0].image;
        } else if (listing.cover_image_url) {
          imageUrl = listing.cover_image_url;
        } else if (listing.image) {
          imageUrl = listing.image;
        }

        card.innerHTML = `
          <img src="${imageUrl}" alt="${listing.title}">
          <div class="card-body">
            <h5>${listing.title}</h5>
            <p>${listing.location || 'Location not specified'}</p>
            <p class="price">₦${Number(listing.price || 0).toLocaleString()}</p>
            <div class="card-actions">
              <button class="edit-btn" onclick="editListing('${listing.id}')">Edit</button>
              <button class="delete-btn" onclick="deleteListing('${listing.id}')">Delete</button>
            </div>
          </div>
        `;

        container.appendChild(card);
      });
    }

    // Show no listings message
    function showNoListingsMessage() {
      const container = document.getElementById("listingsContainer");
      container.innerHTML = `
        <div class="no-listings">
          <h3>No Listings Found</h3>
          <p>You haven't posted any listings yet. Start by posting your first property!</p>
          <a href="post.html" class="post-listing-btn">Post a Listing</a>
        </div>
      `;
    }

    // Show error message
    function showErrorMessage(message) {
      const container = document.getElementById("listingsContainer");
      container.innerHTML = `
        <div class="no-listings">
          <h3>Error Loading Listings</h3>
          <p>${message}</p>
          <button onclick="location.reload()" class="post-listing-btn" style="cursor:pointer;">Retry</button>
        </div>
      `;
    }

    // Edit listing function
    window.editListing = function (listingId) {
      // Store the listing ID to edit
      localStorage.setItem('editingListingId', listingId);

      // Redirect to post page with edit parameter
      window.location.href = `post.html?edit=${listingId}`;
    }

    // Delete listing function
    window.deleteListing = async function (listingId) {
      if (!confirm("Are you sure you want to delete this listing? This action cannot be undone.")) {
        return;
      }

      try {
        // Check if this is an API listing (not a local one)
        if (!listingId.startsWith('local_')) {
          // API delete request
          const response = await fetch(`${API_BASE}/listings/${listingId}/`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          if (!response.ok) {
            throw new Error('Failed to delete listing from server');
          }
        }

        // Also remove from localStorage
        const localListings = JSON.parse(localStorage.getItem("listings")) || [];
        const updatedListings = localListings.filter(listing => listing.id !== listingId);
        localStorage.setItem("listings", JSON.stringify(updatedListings));

        // Reload the listings
        const userEmail = localStorage.getItem("userEmail");
        await loadAgentListings(userEmail);

        alert("Listing deleted successfully!");

      } catch (error) {
        console.error("Error deleting listing:", error);
        alert("Failed to delete listing. Please try again.");
      }
    }

    // Logout function
    window.logout = function () {
      localStorage.clear();
      window.location.href = "login.html";
    }

    // Mobile menu functionality (same as home page)
    // const mobileMenuBtn = document.getElementById("mobileMenuBtn");
    // const desktopNav = document.getElementById("navMenu");

    // if (mobileMenuBtn && desktopNav) {
    //   mobileMenuBtn.addEventListener("click", () => desktopNav.classList.toggle("active"));
    // }
  </script>

</body>

</html>