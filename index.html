<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Book-It | Find Hostels & Lodges</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css">
</head>

<body>

  <!-- NAVBAR -->
  <header class="navbar">
    <a href="index.html" class="logo">
      <img src="logo.png" alt="Book-It Logo">
    </a>

    <!-- Desktop Menu -->
    <nav class="menu-panel desktop-nav" id="navMenu">
      <a href="index.html">Home</a>
      <a href="contact.html">Contact/Support</a>
      <a href="post.html" id="postLink">Post Lodge</a>
      <div class="user-area" id="userArea"></div>
    </nav>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">☰</button>

    <!-- Mobile Menu -->
    <nav class="menu-panel mobile-nav" id="mobileNav"></nav>
  </header>

  <!-- MOBILE SEARCH PILL -->
  <div class="mobile-search-pill" id="mobileSearchPill">
    <span class="search-label">Where are you staying?</span>
    <span class="search-action">Search</span>
  </div>

  <!-- MOBILE SEARCH MODAL -->
  <div class="search-modal" id="searchModal">
    <div class="search-modal-content">
      <h3>Search Hostels</h3>

      <select id="locationInputMobile" class="modern-select">
        <option value="">Select Location</option>
        <option value="1">Ifite, Anambra state</option>
        <option value="2">Amansea</option>
        <option value="3">Ifite-Up School</option>
        <option value="4">Ifite-Down School</option>
        <option value="5">Permanent Site</option>
        <option value="6">Temp Site</option>
        <option value="7">Unizik Gate</option>
        <option value="8">Awka Road</option>
      </select>

      <input type="number" id="minPriceMobile" placeholder="Min ₦">
      <input type="number" id="maxPriceMobile" placeholder="Max ₦">

      <button id="mobileSearchBtn">Search</button>
      <button class="close-btn" id="closeSearchBtn">Cancel</button>
    </div>
  </div>

  <!-- HERO SECTION -->
  <section class="hero">
    <h2>Find Student-Friendly Hostels & Lodges</h2>
    <p>Search by location and budget</p>

    <!-- SEARCH BAR -->
    <div class="search-box">
      <div class="select-wrapper">
        <select id="locationInput" class="modern-select">
          <option value="">Select Location (ID)</option>
          <option value="1">Ifite, Anambra state</option>
          <option value="2">Amansea</option>
          <option value="3">Ifite-Up School</option>
          <option value="4">Ifite-Down School</option>
          <option value="5">Permanent Site</option>
          <option value="6">Temp Site</option>
          <option value="7">Unizik Gate</option>
          <option value="8">Awka Road</option>
        </select>
      </div>

      <input type="number" id="minPrice" placeholder="Min ₦">
      <input type="number" id="maxPrice" placeholder="Max ₦">
      <button onclick="searchListings()">Search</button>
    </div>
  </section>

  <!-- LISTINGS -->
  <section class="listings-container" id="listingsContainer">
    <!-- Listings will be injected here -->
  </section>

  <!-- FOOTER -->
  <footer class="footer">
    <p>© 2025 Book-It. Student housing made easy.</p>
  </footer>

  <!-- API SCRIPT -->
  <script src="js/main.js"></script>

  <script src="js/config.js"></script>
  <script>
    const API_BASE = `${CONFIG.API_BASE_URL}/api`;

    // Helper function to fetch listings
    async function fetchListings() {
      try {
        const res = await fetch(`${API_BASE}/listings/`);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        return data;
      } catch (error) {
        console.error("Error fetching listings:", error);
        return [];
      }
    }

    // Render listings to the page
    function renderListings(listings) {
      const container = document.getElementById("listingsContainer");
      container.innerHTML = "";

      if (listings.length === 0) {
        container.innerHTML = "<p style='text-align:center; padding:40px;'>No listings found.</p>";
        return;
      }

      listings.forEach(listing => {
        const card = document.createElement("div");
        card.className = "listing-card";

        // Get the first image URL from the images array
        let imageUrl = 'https://via.placeholder.com/400';
        if (listing.images && listing.images.length > 0 && listing.images[0].image_url) {
          imageUrl = listing.images[0].image_url;
        } else if (listing.cover_image_url) {
          imageUrl = listing.cover_image_url;
        }

        // Get location name
        const locationName = listing.location_detail?.name || listing.old_location || 'Location not specified';

        // Format room type for display
        const roomType = listing.room_type ? listing.room_type.replace('_', ' ') : 'Room';

        card.innerHTML = `
          <a href="details.html?id=${listing.id}" style="text-decoration:none;color:inherit;display:block;">
            <div class="clickable-card">
              <img src="${imageUrl}" alt="${listing.lodge_name}">
              <div class="card-body">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                  <h5 style="margin:0; flex:1;">${listing.lodge_name}</h5>
                 
                </div>
                <p style="margin:8px 0; color:#666;">
                  <i class="fas fa-map-marker-alt" style="margin-right:5px;"></i>
                  ${locationName}
                </p>

                <p class="price" style="margin:8px 0 0 0; font-size:18px; font-weight:bold;">
                  ₦${Number(listing.price).toLocaleString()}
                  <span style="font-size:14px; font-weight:normal; color:#666;">/year</span>
                </p>
                ${!listing.is_available ? `
                  <div style="background:#ffebee; color:#c62828; padding:4px 8px; border-radius:4px; margin-top:8px; font-size:12px;">
                    Currently Unavailable
                  </div>
                ` : ''}
              </div>
            </div>
          </a>
        `;

        container.appendChild(card);
      });
    }

    // Search/filter function
    async function searchListings() {
      const locationId = document.getElementById("locationInput").value;
      const minPrice = Number(document.getElementById("minPrice").value) || 0;
      const maxPrice = Number(document.getElementById("maxPrice").value) || Infinity;

      const listings = await fetchListings();

      const filtered = listings.filter(l => {
        const price = Number(l.price);
        const priceMatch = price >= minPrice && price <= maxPrice;

        if (!locationId) {
          return priceMatch;
        }

        // Check if location matches either by ID or name
        const locationMatch = l.location == locationId ||
          (l.location_detail && l.location_detail.id == locationId) ||
          (l.location_detail && l.location_detail.name &&
            l.location_detail.name.toLowerCase().includes(locationId.toLowerCase()));

        return locationMatch && priceMatch;
      });

      renderListings(filtered);
    }

    // MOBILE MENU & SEARCH
    const mobileMenuBtn = document.getElementById("mobileMenuBtn");
    const desktopNav = document.getElementById("navMenu");
    mobileMenuBtn.addEventListener("click", () => desktopNav.classList.toggle("active"));

    const searchModal = document.getElementById("searchModal");
    const mobileSearchPill = document.getElementById("mobileSearchPill");
    const closeSearchBtn = document.getElementById("closeSearchBtn");
    const mobileSearchBtn = document.getElementById("mobileSearchBtn");

    mobileSearchPill.addEventListener("click", () => searchModal.classList.add("active"));
    closeSearchBtn.addEventListener("click", () => searchModal.classList.remove("active"));
    mobileSearchBtn.addEventListener("click", () => {
      document.getElementById("locationInput").value = document.getElementById("locationInputMobile").value;
      document.getElementById("minPrice").value = document.getElementById("minPriceMobile").value;
      document.getElementById("maxPrice").value = document.getElementById("maxPriceMobile").value;
      searchModal.classList.remove("active");
      searchListings();
    });

    // Load Font Awesome for icons
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css';
    document.head.appendChild(link);

    // Initial render
    searchListings();
  </script>

</body>

</html>