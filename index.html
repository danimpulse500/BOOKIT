<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Book-It | Find Hostels & Lodges</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css">
  <!-- Load Font Awesome early -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

  <!-- NAVBAR -->
  <header class="navbar">
    <a href="index.html" class="logo">
      <img src="logo.png" alt="Book-It Logo">
    </a>

    <!-- Desktop Menu -->
    <nav class="menu-panel desktop-nav" id="navMenu">
      <a href="index.html">Home</a>
      <a href="contact.html">Contact/Support</a>
      <a href="post.html" id="postLink">Post Lodge</a>
      <div class="user-area" id="userArea"></div>
    </nav>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">☰</button>

    <!-- Mobile Menu -->
    <nav class="menu-panel mobile-nav" id="mobileNav"></nav>
  </header>

  <!-- MOBILE SEARCH PILL -->
  <div class="mobile-search-pill" id="mobileSearchPill">
    <span class="search-label">Where are you staying?</span>
    <span class="search-action">Search</span>
  </div>

  <!-- MOBILE SEARCH MODAL -->
  <div class="search-modal" id="searchModal">
    <div class="search-modal-content">
      <h3>Search Hostels</h3>

      <select id="locationInputMobile" class="modern-select">
        <option value="">Select Location</option>
        <option value="1">Ifite, Anambra state</option>
        <option value="2">Amansea</option>
        <option value="3">Ifite-Up School</option>
        <option value="4">Ifite-Down School</option>
        <option value="5">Permanent Site</option>
        <option value="6">Temp Site</option>
        <option value="7">Unizik Gate</option>
        <option value="8">Awka Road</option>
      </select>

      <input type="number" id="minPriceMobile" placeholder="Min ₦">
      <input type="number" id="maxPriceMobile" placeholder="Max ₦">

      <button id="mobileSearchBtn">Search</button>
      <button class="close-btn" id="closeSearchBtn">Cancel</button>
    </div>
  </div>

  <!-- HERO SECTION -->
  <section class="hero">
    <h2>Find Student-Friendly Hostels & Lodges</h2>
    <p>Search by location and budget</p>

    <!-- SEARCH BAR -->
    <div class="search-box">
      <div class="select-wrapper">
        <select id="locationInput" class="modern-select">
          <option value="">Select Location</option>
          <option value="1">Ifite, Anambra state</option>
          <option value="2">Amansea</option>
          <option value="3">Ifite-Up School</option>
          <option value="4">Ifite-Down School</option>
          <option value="5">Permanent Site</option>
          <option value="6">Temp Site</option>
          <option value="7">Unizik Gate</option>
          <option value="8">Awka Road</option>
          <!-- Additional options based on API response -->
          <option value="AMANSEA">Amansea</option>
          <option value="Ifite">Ifite</option>
          <option value="IFITE_ANAMBRA">Ifite Anambra</option>
          <option value="LAGOS">Lagos</option>
        </select>
      </div>

      <input type="number" id="minPrice" placeholder="Min ₦">
      <input type="number" id="maxPrice" placeholder="Max ₦">
      <button onclick="searchListings()">Search</button>
    </div>
  </section>

  <!-- LISTINGS -->
  <section class="listings-container" id="listingsContainer">
    <!-- Listings will be injected here -->
  </section>

  <!-- FOOTER -->
  <footer class="footer">
    <p>© 2025 Book-It. Student housing made easy.</p>
  </footer>

  <!-- API SCRIPT -->
  <script src="js/main.js"></script>

  <script src="js/config.js"></script>
<script>
    const API_BASE = `${CONFIG.API_BASE_URL}/api`;

    // Helper function to fetch listings
    async function fetchListings() {
      try {
        const res = await fetch(`${API_BASE}/listings/`);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        return data;
      } catch (error) {
        console.error("Error fetching listings:", error);
        // Return sample data for testing if API fails
        return [
          {
            "id": 7,
            "lodge_name": "NEW LODGE",
            "first_price": "300000.00",
            "year_price": "1000000.00",
            "location": "AMANSEA",
            "location_display": "Amansea",
            "is_available": true,
            "cover_image_url": "http://res.cloudinary.com/dx0faws91/image/upload/v1768934860/rilml69h9lu5scd5nrzh.jpg",
            "images": [
              {
                "image_url": "http://res.cloudinary.com/dx0faws91/image/upload/v1768934860/rilml69h9lu5scd5nrzh.jpg"
              }
            ]
          }
        ];
      }
    }

    // Helper to get price for display
    function getDisplayPrice(listing) {
      // Use year_price if available, otherwise use first_price
      return listing.year_price || listing.first_price || 0;
    }

    // Helper to get location name for display
    function getLocationName(listing) {
      if (listing.location_detail && listing.location_detail.name) {
        return listing.location_detail.name;
      }
      if (listing.location_display && listing.location_display !== "1") {
        return listing.location_display;
      }
      if (listing.old_location) {
        return listing.old_location;
      }
      // Format location from the location field
      if (listing.location) {
        // Handle location codes like "1", "2", etc.
        if (['1', '2', '3', '4', '5', '6', '7', '8'].includes(listing.location)) {
          const locationNames = {
            '1': 'Ifite, Anambra state',
            '2': 'Amansea',
            '3': 'Ifite-Up School',
            '4': 'Ifite-Down School',
            '5': 'Permanent Site',
            '6': 'Temp Site',
            '7': 'Unizik Gate',
            '8': 'Awka Road'
          };
          return locationNames[listing.location] || listing.location;
        }
        // Format string locations
        return listing.location.replace(/_/g, ' ').split(' ').map(word => 
          word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
        ).join(' ');
      }
      return 'Location not specified';
    }

    // Format price for display
    function formatPrice(price) {
      if (!price) return '0';
      return Number(price).toLocaleString();
    }

    // Render listings to the page
    function renderListings(listings) {
      const container = document.getElementById("listingsContainer");
      container.innerHTML = "";

      if (!listings || listings.length === 0) {
        container.innerHTML = "<p style='text-align:center; padding:40px;'>No listings found. Try adjusting your search criteria.</p>";
        return;
      }

      listings.forEach(listing => {
        const card = document.createElement("div");
        card.className = "listing-card";

        // Get image URL
        let imageUrl = 'https://via.placeholder.com/400x250?text=No+Image';
        if (listing.cover_image_url) {
          imageUrl = listing.cover_image_url;
        } else if (listing.images && listing.images.length > 0 && listing.images[0].image_url) {
          imageUrl = listing.images[0].image_url;
        }

        // Get location name
        const locationName = getLocationName(listing);

        // Get prices
        const firstPrice = Number(listing.first_price || 0);
        const yearPrice = Number(listing.year_price || 0);
        const hasBothPrices = firstPrice > 0 && yearPrice > 0;

        // Format room type
        const roomType = listing.room_type ? 
          listing.room_type.replace(/_/g, ' ').split(' ').map(word => 
            word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
          ).join(' ') : 
          'Room';

        card.innerHTML = `
          <a href="details.html?id=${listing.id}" style="text-decoration:none;color:inherit;display:block;">
            <div class="clickable-card">
              <img src="${imageUrl}" alt="${listing.lodge_name}" style="width:100%;height:250px;object-fit:cover;border-radius:8px 8px 0 0;">
              <div class="card-body" style="padding:16px;">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                  <h5 style="margin:0; flex:1; font-size:18px; line-height:1.3;">${listing.lodge_name}</h5>
                  <span style="background:#e8f5e9; color:#2e7d32; padding:4px 8px; border-radius:12px; font-size:12px; white-space:nowrap;">
                    ${roomType}
                  </span>
                </div>
                <p style="margin:8px 0; color:#666; font-size:14px;">
                  <i class="fas fa-map-marker-alt" style="margin-right:5px;"></i>
                  ${locationName}
                </p>

                <!-- Price Display -->
                <div style="margin-top:12px;">
                  ${hasBothPrices ? `
                    <div style="display:flex; flex-direction:column; gap:4px;">
                      <div style="display:flex; align-items:center; gap:8px;">
                        <span style="font-size:14px; color:#666;">First Payment:</span>
                        <span style="font-size:16px; font-weight:bold; color:#1a73e8;">
                          ₦${formatPrice(listing.first_price)}
                        </span>
                      </div>
                      <div style="display:flex; align-items:center; gap:8px;">
                        <span style="font-size:14px; color:#666;">Annual Payment:</span>
                        <span style="font-size:16px; font-weight:bold; color:#2e7d32;">
                          ₦${formatPrice(listing.year_price)}
                        </span>
                      </div>
                    </div>
                  ` : `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                      <p class="price" style="margin:0; font-size:18px; font-weight:bold; color:#1a73e8;">
                        ₦${formatPrice(getDisplayPrice(listing))}
                        <span style="font-size:14px; font-weight:normal; color:#666;">/year</span>
                      </p>
                      ${!listing.is_available ? `
                        <div style="background:#ffebee; color:#c62828; padding:4px 8px; border-radius:4px; font-size:12px;">
                          Unavailable
                        </div>
                      ` : `
                        <div style="background:#e8f5e9; color:#2e7d32; padding:4px 8px; border-radius:4px; font-size:12px;">
                          Available
                        </div>
                      `}
                    </div>
                  `}
                  
                  ${hasBothPrices ? `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
                      ${!listing.is_available ? `
                        <div style="background:#ffebee; color:#c62828; padding:4px 8px; border-radius:4px; font-size:12px;">
                          Currently Unavailable
                        </div>
                      ` : `
                        <div style="background:#e8f5e9; color:#2e7d32; padding:4px 8px; border-radius:4px; font-size:12px;">
                          Available for Booking
                        </div>
                      `}
                      <div style="font-size:12px; color:#666;">
                        <i class="fas fa-calendar-alt" style="margin-right:4px;"></i>
                        Flexible Payments
                      </div>
                    </div>
                  ` : ''}
                </div>
                
                ${listing.agency ? `
                  <p style="margin:12px 0 0 0; color:#666; font-size:12px; border-top:1px solid #eee; padding-top:8px;">
                    <i class="fas fa-building" style="margin-right:5px;"></i>
                    Managed by: ${listing.agency}
                  </p>
                ` : ''}
              </div>
            </div>
          </a>
        `;

        container.appendChild(card);
      });
    }

    // Search/filter function
    async function searchListings() {
      const locationValue = document.getElementById("locationInput").value;
      const minPrice = Number(document.getElementById("minPrice").value) || 0;
      const maxPrice = Number(document.getElementById("maxPrice").value) || Infinity;

      const listings = await fetchListings();

      const filtered = listings.filter(listing => {
        const price = Number(getDisplayPrice(listing));
        const priceMatch = price >= minPrice && price <= maxPrice;

        if (!locationValue) {
          return priceMatch;
        }

        // Check location match
        const locationName = getLocationName(listing).toLowerCase();
        const searchLocationLower = locationValue.toLowerCase();
        
        // Match by location ID or name
        const locationMatch = listing.location === locationValue ||
                             locationName.includes(searchLocationLower);

        return locationMatch && priceMatch;
      });

      renderListings(filtered);
    }

    // MOBILE MENU & SEARCH
    const mobileMenuBtn = document.getElementById("mobileMenuBtn");
    const desktopNav = document.getElementById("navMenu");
    mobileMenuBtn.addEventListener("click", () => desktopNav.classList.toggle("active"));

    const searchModal = document.getElementById("searchModal");
    const mobileSearchPill = document.getElementById("mobileSearchPill");
    const closeSearchBtn = document.getElementById("closeSearchBtn");
    const mobileSearchBtn = document.getElementById("mobileSearchBtn");

    mobileSearchPill.addEventListener("click", () => searchModal.classList.add("active"));
    closeSearchBtn.addEventListener("click", () => searchModal.classList.remove("active"));
    mobileSearchBtn.addEventListener("click", () => {
      document.getElementById("locationInput").value = document.getElementById("locationInputMobile").value;
      document.getElementById("minPrice").value = document.getElementById("minPriceMobile").value;
      document.getElementById("maxPrice").value = document.getElementById("maxPriceMobile").value;
      searchModal.classList.remove("active");
      searchListings();
    });

    // Initial render
    window.addEventListener('DOMContentLoaded', () => {
      searchListings();
    });

    // Make function globally available
    window.searchListings = searchListings;
  </script>

</body>

</html>